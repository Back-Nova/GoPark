<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jefe de Ventas | GoPark</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>
<body>
  <div class="admin-bg">
    <header class="admin-header">
      <h1 class="admin-title"><i class="fa-solid fa-user-shield"></i> Jefe de Ventas GoPark</h1>
      <nav class="admin-nav">
        <a href="#paquetes" class="nav-link active"><i class="fa-solid fa-box"></i> Paquetes</a>
      </nav>
    </header>

    <main class="admin-main">
      <!-- Paquetes -->
      <section id="paquetes" class="admin-section">
        <div class="section-header">
          <h2><i class="fa-solid fa-box"></i> Paquetes turísticos</h2>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="admin-nuevo-btn" id="nuevoPaqueteBtn">
              <i class="fa-solid fa-plus"></i> Nuevo Paquete
            </button>
            <button class="admin-nuevo-btn" onclick="location.href='/recursos'">
              <i class="fa-solid fa-cubes"></i> Nuevo Recurso
            </button>
            <button class="admin-nuevo-btn" onclick="location.href='/destino'">
              <i class="fa-solid fa-map-location-dot"></i> Nuevo Destino
            </button>
          </div>
        </div>

        <!-- CONTENEDOR DEL FORMULARIO -->
        <div id="contenedorFormularioPaquete" style="margin-top: 1.5em; display: none;">
            <section class="admin-section" style="box-shadow: 0 0 32px #00f2ff77, 0 2px 12px #00f2ff33; border-radius: 14px; padding: 26px 8px;">
              <h2 style="color:#00f2ff; text-shadow:0 2px 18px #00f2ff55; display:flex; align-items:center; gap:10px; margin-bottom: 16px;">
                <i class="fa-solid fa-box-open"></i> Crear Nuevo Paquete
              </h2>
              <form id="formPaquete" class="destino-form" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px 26px; margin-top: 6px;">
                <div class="form-group">
                  <label for="nombre" style="color:#00f2ff; font-weight:700;">
                    <i class="fa-solid fa-signature"></i> Nombre
                  </label>
                  <input type="text" id="nombre" placeholder="Nombre del paquete" required style="width:100%; padding:1px; border-radius:8px; border:2px solid #00f2ff; background:#101c24; color:#eafcff; font-family:'Orbitron',Arial,sans-serif; font-size:1rem; margin-top:2px;">
                </div>

                <div class="form-group" style="grid-column: span 2;">
                  <label for="descripcion" style="color:#00f2ff; font-weight:700;">
                    <i class="fa-solid fa-align-left"></i> Descripción
                  </label>
                  <textarea id="descripcion" placeholder="Descripción del paquete" rows="3" required style="width:100%; padding:0px; border-radius:8px; border:2px solid #00f2ff; background:#101c24; color:#eafcff; font-family:'Orbitron',Arial,sans-serif; font-size:1rem; margin-top:2px; resize:vertical;"></textarea>
                </div>

                <div class="form-group">
                  <label for="precio" style="color:#00f2ff; font-weight:700;">
                    <i class="fa-solid fa-dollar-sign"></i> Precio
                  </label>
                  <input type="number" id="precio" step="0.01" placeholder="999.99" required style="width:100%; padding:1px; border-radius:8px; border:2px solid #00f2ff; background:#101c24; color:#eafcff; font-family:'Orbitron',Arial,sans-serif; font-size:1rem; margin-top:2px;">
                </div>

                <div class="form-group">
                  <label for="cupos_totales" style="color:#00f2ff; font-weight:700;">
                    <i class="fa-solid fa-users"></i> Cupos Totales
                  </label>
                  <input type="number" id="cupos_totales" placeholder="Ej: 20" required style="width:100%; padding:1px; border-radius:8px; border:2px solid #00f2ff; background:#101c24; color:#eafcff; font-family:'Orbitron',Arial,sans-serif; font-size:1rem; margin-top:2px;">
                </div>

                <div class="form-group">
                  <label for="fecha_inicio" style="color:#00f2ff; font-weight:700;">
                    <i class="fa-solid fa-calendar-day"></i> Fecha Inicio
                  </label>
                  <input type="date" id="fecha_inicio" required style="width:100%; padding:0px; border-radius:8px; border:2px solid #00f2ff; background:#101c24; color:#eafcff; font-family:'Orbitron',Arial,sans-serif; font-size:1rem; margin-top:2px;">
                </div>

                <div class="form-group">
                  <label for="fecha_fin" style="color:#00f2ff; font-weight:700;">
                    <i class="fa-solid fa-calendar-day"></i> Fecha Fin
                  </label>
                  <input type="date" id="fecha_fin" required style="width:100%; padding:1px; border-radius:8px; border:2px solid #00f2ff; background:#101c24; color:#eafcff; font-family:'Orbitron',Arial,sans-serif; font-size:1rem; margin-top:2px;">
                </div>

                <div class="form-group">
                  <label for="tipo" style="color:#00f2ff; font-weight:700;">
                    <i class="fa-solid fa-tag"></i> Tipo
                  </label>
                  <input type="text" id="tipo" placeholder="Ej: Familiar, Aventura" required style="width:100%; padding:1px; border-radius:8px; border:2px solid #00f2ff; background:#101c24; color:#eafcff; font-family:'Orbitron',Arial,sans-serif; font-size:1rem; margin-top:2px;">
                </div>

                <div class="form-group">
                  <label for="disponible" style="color:#00f2ff; font-weight:700;">
                    <i class="fa-solid fa-check"></i> Disponible
                  </label>
                  <select id="disponible" required style="width:100%; padding:1px; border-radius:8px; border:2px solid #00f2ff; background:#101c24; color:#eafcff; font-family:'Orbitron',Arial,sans-serif; font-size:1rem; margin-top:2px;">
                    <option value="true">&#10003; Sí</option>
                    <option value="false">&#10007; No</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="cupos_disponibles" style="color:#00f2ff; font-weight:700;">
                    <i class="fa-solid fa-users"></i> Cupos Disponibles
                  </label>
                  <input type="number" id="cupos_disponibles" placeholder="Ej: 10" required style="width:100%; padding:1px; border-radius:8px; border:2px solid #00f2ff; background:#101c24; color:#eafcff; font-family:'Orbitron',Arial,sans-serif; font-size:1rem; margin-top:2px;">
                </div>

                <div class="form-group">
                  <label for="vuelo" style="color:#00f2ff; font-weight:700;">
                    <i class="fa-solid fa-plane"></i> Vuelo
                  </label>
                  <select id="vuelo" style="width:100%; padding:6px; border-radius:8px; border:2px solid #00f2ff; background:#101c24; color:#eafcff; font-family:'Orbitron',Arial,sans-serif; font-size:1rem; margin-top:2px;">
                    <option value="">Seleccionar vuelo</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="vehiculo" style="color:#00f2ff; font-weight:700;">
                    <i class="fa-solid fa-car"></i> Vehículo
                  </label>
                  <select id="vehiculo" style="width:100%; padding:6px; border-radius:8px; border:2px solid #00f2ff; background:#101c24; color:#eafcff; font-family:'Orbitron',Arial,sans-serif; font-size:1rem; margin-top:2px;">
                    <option value="">Seleccionar vehículo</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="alojamiento" style="color:#00f2ff; font-weight:700;">
                    <i class="fa-solid fa-hotel"></i> Alojamiento
                  </label>
                  <select id="alojamiento" style="width:100%; padding:6px; border-radius:8px; border:2px solid #00f2ff; background:#101c24; color:#eafcff; font-family:'Orbitron',Arial,sans-serif; font-size:1rem; margin-top:2px;">
                    <option value="">Seleccionar alojamiento</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="excursion" style="color:#00f2ff; font-weight:700;">
                    <i class="fa-solid fa-person-hiking"></i> Excursión
                  </label>
                  <select id="excursion" style="width:100%; padding:6px; border-radius:8px; border:2px solid #00f2ff; background:#101c24; color:#eafcff; font-family:'Orbitron',Arial,sans-serif; font-size:1rem; margin-top:2px;">
                    <option value="">Seleccionar excursión</option>
                  </select>
                </div>

                <div style="grid-column: 1 / -1; display:flex; justify-content:flex-end; margin-top:16px;">
                  <button type="submit" style="padding:5px 27px; background:linear-gradient(90deg,#00f2ff 30%,#1b2326 100%); color:#071a1b; border:2px solid #00f2ff; border-radius:10px; font-family:'Orbitron',Arial,sans-serif; font-size:1.09rem; font-weight:900; letter-spacing:1px; cursor:pointer; box-shadow:0 0 18px #00f2ff66; transition:background 0.19s, color 0.19s, box-shadow 0.19s; display:flex; align-items:center; gap:10px;">
                    <i class="fa-solid fa-plus"></i> Crear Paquete
                  </button>
                </div>
              </form>
            </section>
        </div>

        <div class="admin-lista" id="paquetesLista"></div>
      </section>
    </main>

    <footer class="admin-footer">
      Echo por alumnos E.E.T N°3139 Gral M Miguel De Guemes
    </footer>
  </div>

  <!-- JavaScript -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {

    console.log("DOM cargado");

    document.getElementById("nuevoPaqueteBtn").addEventListener("click", () => {
      const formulario = document.getElementById("contenedorFormularioPaquete");
      formulario.style.display = (formulario.style.display === "none" || !formulario.style.display)
        ? "block"
        : "none";
      console.log("Toggle formulario nuevo paquete, display =", formulario.style.display);
    });

    cargarOpciones();
    cargarPaquetes();

    document.getElementById("btnCrearPaquete").addEventListener("click", async () => {
      console.log("Creando nuevo paquete...");

      const nombre = document.getElementById("nombre").value.trim();
      const descripcion = document.getElementById("descripcion").value.trim();
      const precio = parseFloat(document.getElementById("precio").value);
      const cupos_totales = parseInt(document.getElementById("cupos_totales").value);
      const cupos_disponibles = parseInt(document.getElementById("cupos_disponibles").value);
      const fecha_inicio = document.getElementById("fecha_inicio").value;
      const fecha_fin = document.getElementById("fecha_fin").value;
      const tipo = document.getElementById("tipo").value.trim();
      const disponible = document.getElementById("disponible").value === "true";
      const vuelo = document.getElementById("vuelo").value;
      const vehiculo = document.getElementById("vehiculo").value;
      const alojamiento = document.getElementById("alojamiento").value;
      const excursion = document.getElementById("excursion").value;

      console.log("Datos ingresados:", {
        nombre, descripcion, precio, cupos_totales, cupos_disponibles,
        fecha_inicio, fecha_fin, tipo, disponible, vuelo, vehiculo, alojamiento, excursion
      });

      if (
        !nombre || !descripcion || isNaN(precio) || isNaN(cupos_totales) || isNaN(cupos_disponibles) ||
        !fecha_inicio || !fecha_fin || !tipo || vuelo === "" || vehiculo === "" || alojamiento === "" || excursion === ""
      ) {
        console.warn("Faltan datos o datos incorrectos");
        alert("Por favor, completá todos los campos correctamente.");
        return;
      }

      const paquete = {
        nombre,
        descripcion,
        precio,
        cupos_totales,
        cupos_disponibles,
        fecha_inicio,
        fecha_fin,
        tipo,
        disponible,
        vuelo,
        vehiculo,
        alojamiento,
        excursion
      };

      try {
        console.log("Enviando paquete al servidor:", paquete);
        const res = await fetch("/api/paquetes", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(paquete)
        });

        console.log("Respuesta del servidor:", res.status, res.statusText);

        if (res.ok) {
          alert("✅ Paquete creado correctamente.");
          cargarPaquetes();
          document.getElementById("contenedorFormularioPaquete").style.display = "none";
          resetearFormulario();
        } else {
          const errorTexto = await res.text();
          console.error("Error en la respuesta del servidor:", errorTexto);
          traceback.print_exc() 
          alert("❌ Error al crear el paquete.");
        }
      } catch (error) {
        console.error("Error de red o excepción al enviar paquete:", error);
        traceback.print_exc() 
        alert("❌ Error de red al crear paquete.");
      }
    });
  });

  async function cargarOpciones() {
    console.log("Cargando opciones para selects...");

    try {
      const [vuelosRes, vehiculosRes, alojamientosRes, excursionesRes] = await Promise.all([
        fetch("/api/vuelos"),
        fetch("/api/vehiculos"),
        fetch("/api/alojamientos"),
        fetch("/api/excursiones")
      ]);

      if (!vuelosRes.ok || !vehiculosRes.ok || !alojamientosRes.ok || !excursionesRes.ok) {
        console.warn("Algún fetch de opciones falló:",
          vuelosRes.status, vehiculosRes.status, alojamientosRes.status, excursionesRes.status);
        alert("Error al cargar datos para los selects.");
        return;
      }

      const vuelos = await vuelosRes.json();
      const vehiculos = await vehiculosRes.json();
      const alojamientos = await alojamientosRes.json();
      const excursiones = await excursionesRes.json();

      console.log("Datos cargados:", { vuelos, vehiculos, alojamientos, excursiones });

      cargarSelect("vuelo", vuelos, "id_vuelo", "aerolinea");
      cargarSelect("vehiculo", vehiculos, "id_vehiculo", "modelo");
      cargarSelect("alojamiento", alojamientos, "id_alojamiento", "nombre");
      cargarSelect("excursion", excursiones, "id_excursion", "nombre");
    } catch (error) {
      console.error("Error al cargar opciones:", error);
      alert("❌ Error al cargar datos para los selects.");
      traceback.print_exc() 
    }
  }

  function cargarSelect(id, datos, valor, texto) {
    const select = document.getElementById(id);
    select.innerHTML = '<option value="">Seleccionar</option>';
    datos.forEach(item => {
      const option = document.createElement("option");
      option.value = item[valor];
      option.textContent = item[texto];
      select.appendChild(option);
    });
    console.log(`Select '${id}' cargado con ${datos.length} opciones.`);
  }

  async function cargarPaquetes() {
  const contenedor = document.getElementById("paquetesLista");
  contenedor.innerHTML = "";
  console.log("Cargando paquetes...");

  try {
    const res = await fetch("/api/paquetes");
    if (!res.ok) {
      console.error("Error al obtener paquetes, status:", res.status);
      contenedor.innerHTML = "<p style='color:red;'>Error al cargar paquetes. este es el que complica</p>";
      traceback.print_exc()
      console.error("Error de red o respuesta no OK:", res.statusText);
      return;
    }

    //  CAMBIO 
    const datos = await res.json();
    const paquetes = datos.paquetes || [];

    if (paquetes.length === 0) {
      contenedor.innerHTML = "<p style='color:white;'>No hay paquetes cargados.</p>";
      return;
    }

    paquetes.forEach(p => {
      const div = document.createElement("div");
      div.style = "border: 1px solid #00f2ff; margin-bottom: 10px; padding: 10px; border-radius: 10px; color: white; font-family:'Orbitron', sans-serif;";
      
      div.innerHTML = `
        <p><strong>Nombre:</strong> ${p.nombre}</p>
        <p><strong>Descripción:</strong> ${p.descripcion}</p>
        <p><strong>Precio:</strong> $${p.precio}</p>
        <p><strong>Cupos:</strong> ${p.cupos_disponibles} / ${p.cupos_totales}</p>
        <p><strong>Fechas:</strong> ${p.fecha_inicio} a ${p.fecha_fin}</p>
        <p><strong>Tipo:</strong> ${p.tipo}</p>
        <p><strong>Disponible:</strong> ${p.disponible ? "Sí" : "No"}</p>
        <p><strong>Vuelo:</strong> ${p.vuelo_texto || p.vuelo}</p>
        <p><strong>Vehículo:</strong> ${p.vehiculo_texto || p.vehiculo}</p>
        <p><strong>Alojamiento:</strong> ${p.alojamiento_texto || p.alojamiento}</p>
        <p><strong>Excursión:</strong> ${p.excursion_texto || p.excursion}</p>
        <button onclick="eliminarPaquete(${p.id_paquete})" style="background:red;color:white;padding:4px 10px;border:none;border-radius:6px;margin-top:5px;">Eliminar</button>
      `;
      contenedor.appendChild(div);
    });

    console.log(`${paquetes.length} paquetes cargados y mostrados.`);
  } catch (error) {
    console.error("Error al cargar paquetes este es el que me complica:", error);
    contenedor.innerHTML = "<p style='color:red;'>Error al cargar paquetes.</p>";
  }
}

  async function eliminarPaquete(id) {
    console.log("Intentando eliminar paquete con id:", id);
    if (!confirm("¿Seguro que querés eliminar este paquete?")) return;

    try {
      const res = await fetch(`/api/paquetes/${id}`, { method: "DELETE" });
      console.log("Respuesta eliminación:", res.status);
      if (res.ok) {
        alert("🗑️ Paquete eliminado.");
        cargarPaquetes();
      } else {
        alert("❌ No se pudo eliminar.");
      }
    } catch (error) {
      console.error("Error al eliminar paquete:", error);
      alert("❌ Error al eliminar paquete.");
    }
  }

  function resetearFormulario() {
    const campos = [
      "nombre", "descripcion", "precio", "cupos_totales", "cupos_disponibles",
      "fecha_inicio", "fecha_fin", "tipo", "disponible",
      "vuelo", "vehiculo", "alojamiento", "excursion"
    ];

    campos.forEach(id => {
      const elem = document.getElementById(id);
      if (elem) {
        if (elem.type === "checkbox" || elem.type === "radio") {
          elem.checked = false;
        } else {
          elem.value = "";
        }
      }
    });
    console.log("Formulario reseteado");
  }

  </script>
</body>
</html>
